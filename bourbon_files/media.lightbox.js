define(["modules/util/util.instances","modules/util/util.model","jq!starfield/jquery.mod","libs/fancybox/fancybox"],function(a,b,c){function e(a,c){this.$element=a,this.model=new b(c),this.mode=this.model.get("mode"),this.i18N=this.model.get("i18N"),this.subscriptions=[],this.init()}var d="wsb-media-carousel";e.prototype={$titleTemplate:!1,init:function(){var a=this;if(this.model.isKO){var b=function(){a.refresh()};this.subscriptions.push(this.model.get("localizedAssets",!0).subscribe(b));var d=this.model.get("mutatorViewModel",!0);if(d)for(var e in d)this.model.ko.isObservable(d[e])&&this.subscriptions.push(d[e].subscribe(b))}this.$titleTemplate||(this.$titleTemplate=c("<div/>").addClass("fancybox-title fancybox-title-float-wrap").append(c("<span/>").addClass("child"))),this.refresh(this.mode=="designer"&&this.model.get("isNew"))},refresh:function(a){this.assets=this.model.get("localizedAssets")||this.model.get("CarouselAssets"),this.$element.children().remove();for(var b=0;b<this.assets.length;b++)this.addAsset(this.assets[b],b+1);if(this.mode=="designer")this.model.set("minWidth",c("> a:first",this.$element).outerWidth(!0)),this.model.set("isNew",a),this.updateOverlay();else if(this.mode=="desktop"){var d=this,e=!1,f=c("a",this.$element),g=this.model.get("preview"),h=this.model.get("CarouselCaption");f.selector="",f.fancybox({afterLoad:function(a){e=a},afterShow:function(){if(e){var a=d.assets[e.index];if(a){c(".fancybox-next").attr("title",d.i18N.resources.Next),c(".fancybox-prev").attr("title",d.i18N.resources.Previous);if(h||a.link){var b=c(".fancybox-title",e.theme);b.length||(b=d.$titleTemplate.clone().insertAfter(c(".fancybox-outer",e.skin)));if(a.link){var f=c("<a/>").addClass("fancy-title-float-wrap-link").attr("href",a.link);Boolean(a.link.match(/^((http|https|ftp|mailto):|\/\/)/i))?f.attr("target","_blank"):g&&f.one("click",function(){c.fancybox.close()}),f.appendTo(b)}h&&!a.caption&&c("span",b).text(d.i18N.resources.Image+" "+(e.index+1)+"/"+d.assets.length)}}}},beforeClose:function(){e=!1}})}},updateOverlay:function(){var a=c("."+d+"-overlay",this.$element);a.length||c("<div/>").addClass(d+"-overlay").css({filter:"alpha(opacity = 0)","background-color":"transparent"}).appendTo(this.$element)},addAsset:function(a){var b=this,e=a.src||"/document/"+a.id,f=this.model.get("CarouselCaption")&&a.caption?a.caption:null,g=e,h=null;this.mode=="mobile"&&a.link&&(g=a.link,Boolean(a.link.match(/^((https?|ftp|file):\/{2}|mailto:)/i))&&(h="_blank"));var i=c("<a/>").addClass(d+"-wrapper").addClass("loading").css({height:"100%",width:"100%"}).attr({rel:d+"-"+this.mode+"-"+this.model.get("ID"),href:g,title:f,target:h,"data-fancybox-type":"image"}).css({height:this.model.get("CarouselThumbSize"),width:this.model.get("CarouselThumbSize"),margin:this.model.get("CarouselThumbSpacing"),display:"inline-block","vertical-align":"middle"}).appendTo(this.$element),j=c("<img/>").bind("load",function(){j.appendTo(i.removeClass("loading"));var a=j.width(),c=j.height(),d=i.width(),e=i.height();a>c?j.css({height:e,left:-(a*(e/c)-d)/2}):a<c?j.css({width:d,top:-(c*(d/a)-e)/2}):j.css({width:d,height:e});var f=b.model.get("CarouselTheme");f&&i.addClass(f),j.unbind("load")});j[0].src=e},destroy:function(){for(var a in this.subscriptions)this.subscriptions[a].dispose();f.destroy(this.$element),this.$element.remove()}};var f=new a(d,e);return{render:function(a,b){var c=f.get(a);return c?c.refresh():c=f.create(a,b),c},destroy:function(a){var b=f.get(a);return b?(f.destroy(a),!0):!1}}})